apply plugin: 'maven'
import org.apache.tools.ant.filters.ReplaceTokens

libsDirName="."
version="1.0.1"
sourceCompatibility=1.6
targetCompatibility=1.6
javaHome = getJavaHomeVar()
dipforgeHome = "${projectDir}/dipforge/".toString()


dependsOn(':libs:CoadunationBase')
dependsOn(':libs:CoadunationAnnotations')
dependsOn(':libs:CoadunationClient')
dependsOn(':libs:CoadunationSecurity')
dependsOn(':libs:CoadunationCommon')
dependsOn(':libs:CoadunationLib')
dependsOn(':libs:CoadunationHibernate')
dependsOn(':auth:CoadunationRDBAuth')
dependsOn(':client:DeploymentDaemonClient')
dependsOn(':client:DesktopServerClient')
dependsOn(':client:DNSServerClient')
dependsOn(':client:MessageServiceClient')
dependsOn(':libs:CoadunationUtil')
dependsOn(':client:EmailServerClient')
dependsOn(':client:EventServerClient')
dependsOn(':client:HsqlDBEngineClient')
dependsOn(':client:RDBUserManagerClient')
dependsOn(':client:RSSReaderClient')
dependsOn(':client:ServiceBrokerClient')
dependsOn(':client:TimerClient')
dependsOn(':client:TomcatClient')
dependsOn(':cli:DeploymentDaemonCommandLineTool')
dependsOn(':cli:MessageServiceCommandLineTool')
dependsOn(':cli:ServiceBrokerCommandLineTool')
dependsOn(':cli:TimerCommandLineTool')
dependsOn(':utils:CoadunationUtil')
dependsOn(':daemon:0005-DNSServer')
dependsOn(':daemon:0010-HsqlDBEngineDaemon')
dependsOn(':daemon:0020-RDBUserManager')
dependsOn(':daemon:0040-MessageService')
dependsOn(':daemon:0040-ServiceBroker')
dependsOn(':daemon:0045-EmailServer')
dependsOn(':daemon:0050-DesktopServer')
dependsOn(':daemon:0050-EventServer')
dependsOn(':daemon:0050-Timer')
dependsOn(':daemon:0060-Tomcat')
dependsOn(':daemon:0101-DeploymentDaemon')
dependsOn(':daemon:0102-RSSReader')
dependsOn(':web:CoadunationAdmin')
dependsOn(':web:CoadunationDesktop')
dependsOn(':web:FileManager')
dependsOn(':rdf:SchemaUtils')
dependsOn(':web:SchemaStore')
dependsOn(':rdf:Semantics')
dependsOn(':rdf:CoadunationSemantics')
dependsOn(':rdf:CommonTypes')
dependsOn(':client:AuditTrail')
dependsOn(':daemon:0100-AuditTrailServer')
dependsOn(':daemon:0150-CoadunationTypeManager')
dependsOn(':web:lib:CoadunationGWTLibrary')
dependsOn(':web:lib:WebLibs')
dependsOn(':web:lib:AuditTrailGWT')
dependsOn(':web:AuditTrailConsole')
dependsOn(':libs:GroovyServletBootStrap')
dependsOn(':libs:GroovyLib')
dependsOn(':web:DipforgeWeb')

repositories {
    mavenCentral()
    mavenRepo urls: "http://repository.jboss.org/maven2/"
    mavenRepo urls: "http://www.mvnsearch.org/maven2/"
    mavenRepo urls: "http://repo1.maven.org/maven2/"
    mavenRepo urls: "http://www.jraf.org/static/maven/2/"
    mavenRepo urls: "http://tomcat.apache.org/dev/dist/m2-repository"
    mavenRepo urls: "file://localhost/$projectDir/../maven"
}

configurations {
    releaseSbin
    releaseLibs
    releaseClients
    releaseBin
    releaseDaemon
    releaseWeb
    releaseTools
    releaseRDFClients
    releaseExtractWeb
    releaseGroovyLib
    compile
}

task compile {
}

task copyToSbin(type: Copy) {
    into "dipforge/sbin/"
    from configurations.releaseSbin
}

task copyToLib(type: Copy) {
    into "dipforge/lib/"
    from configurations.releaseLibs
    exclude "**/*CoadunationBase*"
    exclude "**/*CoadunationUtil*"
}

task copyToClient(type: Copy) {
    into "dipforge/clientlib/"
    from configurations.releaseClients
}
task copyToRDFClient(type: Copy) {
    into "dipforge/clientlib/rdf/"
    from configurations.releaseRDFClients
}

task copyToDaemon(type: Copy) {
    into "dipforge/deploy/"
    from configurations.releaseDaemon
    include "**/0*" + version + ".jar"
    include "**/1*" + version + ".jar"
}

task copyWarToDaemon(type: Copy) {
    into "dipforge/deploy/"
    from configurations.releaseWeb
    include "**/*" + version + ".war"
}

release.doLast {
    ant.unzip(
        src: "$projectDir/../web/SchemaStore/build/SchemaStore-${version}.war" , 
        dest: "$projectDir/dipforge/var/tomcat/webapps/schema")
}

task copyToTools(type: Copy) {
    into "dipforge/tools/"
    from configurations.releaseTools
    include "**/*CommandLine*" + version + ".jar"
}

task copyBinTemplate(type: Copy) {
    from "${projectDir}/template/bin/"
    into "${projectDir}/dipforge/bin/"
    include 'run.bat'
    include 'run.sh'
    fileMode=00755
    filter(ReplaceTokens, tokens:[dipforge_home: dipforgeHome, dipforge_version: version, hostname: InetAddress.getLocalHost().getHostName(), java_home: javaHome] )
}

task copyEtcTemplate(type: Copy) {
    from "${projectDir}/template/etc/"
    into "${projectDir}/dipforge/etc/"
    include 'config.xml'
    include 'log4j.properties'
    include 'server.policy'
    filter(ReplaceTokens, tokens:[dipforge_home: dipforgeHome, dipforge_version: version,java_home: javaHome, hostname: InetAddress.getLocalHost().getHostName()] )
}

task copySemanticTemplate(type: Copy) {
    from "${projectDir}/template/var/semantics/"
    into "${projectDir}/dipforge/var/semantics/"
    include "*.ttl"
    filter(ReplaceTokens, tokens:[hostname: InetAddress.getLocalHost().getHostName()] )
}

task copyWebManagerToTomcat(type: Copy) {
    into "${projectDir}/dipforge/var/tomcat/webapps/manager"
    from "${projectDir}/template/web/manager"
}

task copyToGroovyLib(type: Copy) {
    into "dipforge/var/groovylib/"
    from configurations.releaseGroovyLib
    exclude "**/*servlet-api*"
}

task clean {
    ant {
        delete {
            fileset(dir: "dipforge"){
                include(name: "**/*.war")
                include(name: "**/*.jar")
            }
        }
        delete (includeEmptyDirs:true){
            fileset(dir: "dipforge/var/tomcat/webapps"){
                exclude(name: "**/*.keepme")
            }
        }
        delete {
            fileset(dir: "dipforge/var/tomcat/conf/Coadunation"){
                include(name: "**/*.xml")
            }
        }
        delete (includeEmptyDirs:true){
            fileset(dir: "dipforge/var/tomcat/work"){
                exclude(name: "**/*.keepme")
            }
        }
        delete {
            fileset(dir: "dipforge/bin"){
                include(name: "**/*.bat")
                include(name: "**/*.sh")
            }
        }
        delete {
            fileset(dir: "dipforge/etc"){
                include(name: "**/config.xml")
                include(name: "**/*.policy")
                include(name: "**/*.properties")
            }
        }
        delete {
            fileset(dir: "dipforge/log"){
                include(name: "**/*.*")
            }
        }
        delete (includeEmptyDirs:true){
            fileset(dir: "dipforge/var/hsqldb"){
                exclude(name: "**/*.keepme")
            }
        }
        delete {
            fileset(dir: "dipforge/var/semantics"){
                include(name: "**/*.ttl")
            }
        }
        delete {
            fileset(dir: "dipforge/var/groovylib"){
                include(name: "**/*.jar")
            }
        }
    }
}


dependencies {
    // compile
    
    // release boot strap file
    releaseSbin project(':libs:CoadunationBase') {transitive = true}
    
    // release libraries
    releaseLibs project(':libs:CoadunationClient') {transitive = true}
    releaseClients project(':libs:CoadunationClient') {transitive = true}
    releaseLibs project(':libs:CoadunationSecurity') {transitive = true}
    releaseLibs project(':libs:CoadunationHibernate') {transitive = true}
    releaseLibs project(':libs:CoadunationUtil') {transitive = true}
    releaseLibs project(':auth:CoadunationRDBAuth') {transitive = true}
    releaseLibs project(':libs:CoadunationLib') {transitive = true}
    releaseLibs group: 'backport-util-concurrent', name: 'backport-util-concurrent', version: '3.1', ext: 'jar'
    releaseLibs group: 'org.hibernate', name: 'hibernate-c3p0', version: '3.5.1-Final', ext: 'jar'
    releaseLibs group: 'commons-cli', name: 'commons-cli', version: '1.0', ext: 'jar'
    releaseLibs group: 'commons-collections', name: 'commons-collections', version: '3.2.1', ext: 'jar'
    releaseLibs group: 'commons-dbcp', name: 'commons-dbcp', version: '1.2.2', ext: 'jar'
    releaseLibs group: 'commons-discovery', name: 'commons-discovery', version: '0.2', ext: 'jar'
    releaseLibs group: 'commons-logging', name: 'commons-logging', version: '1.0.4', ext: 'jar'
    releaseLibs group: 'commons-pool', name: 'commons-pool', version: '1.3', ext: 'jar'
    releaseLibs group: 'jotm', name: 'jotm', version: '2.0.10', ext: 'jar'
    releaseLibs group: 'jotm', name: 'objectweb-datasource', version: '1.0', ext: 'jar'
    releaseLibs group: 'javax.resource', name: 'connector-api', version: '1.5', ext: 'jar'
    releaseLibs group: 'com.sun.jndi', name: 'cosnaming', version: '1.2.1-Local', ext: 'jar'
    releaseLibs group: 'dom4j', name: 'dom4j', version: '1.6.1', ext: 'jar'
    releaseLibs group: 'net.sf.ehcache', name: 'ehcache', version: '1.2.3', ext: 'jar'
    releaseLibs group: 'org.hibernate', name: 'hibernate-cglib-repack', version: '2.1_3', ext: 'jar'
    releaseLibs group: 'howl', name: 'howl-logger', version: '0.1.11', ext: 'jar'
    releaseLibs group: 'org.hsqldb', name: 'hsqldb', version: '2.0.0', ext: 'jar'
    releaseLibs group: 'org.apache.httpcomponents', name: 'httpcore-nio', version: '4.1-beta2', ext: 'jar'
    releaseLibs group: 'org.objectweb.carol', name: 'carol', version: '2.2.10', ext: 'jar'
    releaseLibs group: 'org.objectweb.carol', name: 'carol-iiop-delegate', version: '2.2.10', ext: 'jar'
    releaseLibs group: 'javax.jts', name: 'jts', version: '1.0', ext: 'jar'
    releaseLibs group: 'avalon', name: 'avalon-logkit', version: '1.2', ext: 'jar'
    releaseLibs group: 'mysql', name: 'mysql-connector-java', version: '5.0.8', ext: 'jar'
    releaseLibs group: 'com.sun.jndi', name: 'providerutil', version: '1.2-Local', ext: 'jar'
    releaseLibs group: 'org.slf4j', name: 'slf4j-api', version: '1.5.8', ext: 'jar'
    releaseLibs group: 'org.slf4j', name: 'slf4j-log4j12', version: '1.5.8', ext: 'jar'
    releaseLibs group: 'com.experlog', name: 'xapool', version: '1.4', ext: 'jar'
    releaseLibs group: 'xstream', name: 'xstream', version: '1.1.3', ext: 'jar'
    releaseLibs group: 'axis', name: 'axis-saaj', version: '1.4', ext: 'jar'
    releaseLibs group: 'axis', name: 'axis-jaxrpc', version: '1.4', ext: 'jar'
    releaseLibs group: 'javassist', name: 'javassist', version: '3.4.GA', ext: 'jar'
    releaseLibs group: 'org.ow2.carol.irmi', name: 'irmi', version: '1.1.2', ext: 'jar'
    releaseLibs group: 'antlr', name: 'antlr', version: '2.7.7', ext: 'jar'

    // release clients
    releaseClients project(':client:DeploymentDaemonClient')
    releaseClients project(':client:DesktopServerClient')
    releaseClients project(':client:DNSServerClient')
    releaseClients project(':client:MessageServiceClient')
    releaseClients project(':client:EmailServerClient')
    releaseClients project(':client:EventServerClient')
    releaseClients project(':client:HsqlDBEngineClient')
    releaseClients project(':client:RDBUserManagerClient')
    releaseClients project(':client:RSSReaderClient')
    releaseClients project(':client:ServiceBrokerClient')
    releaseClients project(':client:TimerClient')
    releaseClients project(':client:TomcatClient')
    
    // release rdf libs
    releaseRDFClients project(':rdf:SchemaUtils')
    releaseRDFClients project(':rdf:Semantics')
    releaseRDFClients project(':rdf:CoadunationSemantics')
    releaseRDFClients project(':rdf:CommonTypes')
    
    // copy to tools
    releaseTools project(':cli:DeploymentDaemonCommandLineTool') {transitive = true}
    releaseTools project(':cli:MessageServiceCommandLineTool') {transitive = true}
    releaseTools project(':cli:ServiceBrokerCommandLineTool') {transitive = true}
    releaseTools project(':cli:TimerCommandLineTool') {transitive = true}

    // release daemons
    releaseDaemon project(':daemon:0005-DNSServer') {transitive = false}
    releaseDaemon project(':daemon:0010-HsqlDBEngineDaemon') {transitive = false}
    releaseDaemon project(':daemon:0020-RDBUserManager') {transitive = false}
    releaseDaemon project(':daemon:0040-ServiceBroker') {transitive = false}
    releaseDaemon project(':daemon:0040-MessageService') {transitive = false}
    releaseDaemon project(':daemon:0045-EmailServer') {transitive = false}
    releaseDaemon project(':daemon:0050-DesktopServer') {transitive = false}
    releaseDaemon project(':daemon:0050-EventServer') {transitive = false}
    releaseDaemon project(':daemon:0050-Timer') {transitive = false}
    releaseDaemon project(':daemon:0060-Tomcat') {transitive = false}
    releaseDaemon project(':daemon:0101-DeploymentDaemon') {transitive = false}
    releaseDaemon project(':daemon:0102-RSSReader') {transitive = false}
    releaseDaemon project(':daemon:0100-AuditTrailServer')
    releaseDaemon project(':daemon:0150-CoadunationTypeManager')
    
    // release web
    releaseWeb project(':web:CoadunationAdmin')
    releaseWeb project(':web:CoadunationDesktop')
    releaseWeb project(':web:FileManager')
    releaseWeb project(':web:AuditTrailConsole')
    releaseWeb project(':web:CoadunationTypeManagerConsole')
    releaseWeb project(':web:DipforgeWeb')

    // release extract web
    releaseExtractWeb project(':web:SchemaStore')

    // groovy lib
    releaseGroovyLib project(':libs:GroovyServletBootStrap')
    releaseGroovyLib project(':rdf:Semantics')
    releaseGroovyLib project(':rdf:CoadunationSemantics')
    
}


task build(dependsOn:[copyToSbin,copyToLib,copyToClient,copyToDaemon,copyWarToDaemon,copyToTools,copyToRDFClient,copyBinTemplate,copyEtcTemplate,copyWebManagerToTomcat,copySemanticTemplate,copyToGroovyLib]) {
}

release.dependsOn build

def getJavaHomeVar() {
    def javaHome = System.properties["java.home"]
    if (javaHome.endsWith("/jre")) {
        javaHome = javaHome.substring(0,javaHome.length() - "/jre".length())
    }
    return javaHome
}
